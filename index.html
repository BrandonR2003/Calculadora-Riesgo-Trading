<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cal Automática — Opciones de Riesgo</title>
  <link rel="icon" href="logo.ico">

  <style>
    /* === Estilo igual al original === */
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
      background-color: #121212;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }

    #container {
      display: flex;
      gap: 40px;
      transition: all 0.5s ease;
    }

    .card {
      background-color: #1e1e1e;
      padding: 20px;
      border-radius: 20px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.4);
      width: 350px;
      transition: all 0.5s ease;
    }

    h2 {
      text-align: center;
      margin-bottom: 1px;
      color: #fff;
    }

    label {
      display: block;
      margin-top: 2px;
      font-size: 0.9rem;
    }

    input, select {
      width: 100%;
      padding: 4px;
      margin-top: 2px;
      background-color: #2c2c2c;
      border: none;
      border-radius: 8px;
      color: white;
      font-size: 0.8rem;
      box-sizing: border-box;
    }

    button {
      width: 100%;
      margin-top: 15px;
      padding: 8px;
      background-color: #0a84ff;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    button:hover {
      background-color: #006be6;
    }

    #resultCard {
      display: none;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 0.85rem;
    }

    th, td {
      border: 1px solid #333;
      padding: 6px;
      text-align: center;
    }

    th {
      background-color: #2c2c2c;
    }

    .valid-row {
      background-color: #1f4d1f;
      color: #e8ffe8;
    }

    .best-row {
      background-color: #2a7f2a;
      color: white;
      font-weight: bold;
    }

    @media (max-width: 600px) {
      body {
        height: auto;
        padding: 20px 0;
        align-items: flex-start;
        display: flex;
        justify-content: center;
      }

      #container {
        flex-direction: column;
        gap: 20px;
        width: 100%;
        padding: 0 15px;
        justify-content: center;
      }

      .card {
        width: 100% !important;
        max-width: 350px;
        margin: auto;
        box-sizing: border-box;
        padding: 15px;
      }

      h2 {
        font-size: 1.3rem;
      }

      input, select {
        font-size: 0.95rem;
        padding: 8px;
      }

      button {
        padding: 12px;
        font-size: 1rem;
      }

      table {
        font-size: 0.8rem;
      }
    }
  </style>
</head>

<body>
  <div id="container">

    <!-- INPUTS (minimalistas) -->
    <div class="card" id="inputCard">
      <h2>DATOS</h2>
      <br>
      <br>

      <label for="symbol">Divisa:</label>
      <select id="symbol">
        <option value="EUR/USD">EUR/USD</option>
        <option value="USD/JPY">USD/JPY</option>
        <option value="GBP/USD">GBP/USD</option>
        <option value="XAU/USD_OANDA">XAU/USD OANDA</option>
        <option value="XAU/USD">XAU/USD IC Markets</option>
      </select>

      <br>
      <label for="comision">Tipo de Cuenta:</label>
      <select id="comision">
        <!-- valores = comisión por lote en USD -->
        <option value="7">Apollo</option>
        <option value="6">Personal</option>
      </select>

      <br>
      <label for="capital">Capital ($):</label>
      <select id="capital">
        <option value="1000">$1,000</option>
        <option value="5000">$5,000</option>
        <option value="6000">$6,000</option>
        <option value="10000">$10,000</option>
        <option value="15000">$15,000</option>
        <option value="20000">$20,000</option>
        <option value="25000">$25,000</option>
        <option value="50000">$50,000</option>
        <option value="100000">$100,000</option>
        <option value="200000">$200,000</option>
      </select>

      <br>
      <label for="slTics">Tics SL:</label>
      <input type="number" inputmode="numeric" pattern="[0-9]" id="slTics" step="1" />

      <button onclick="calcular()">Calcular</button>
    </div>

    <!-- RESULTADOS: tabla de opciones válidas -->
    <div class="card" id="resultCard">
      <h2>OPCIONES DE RIESGO</h2>

      <table>
        <thead>
          <tr>
            <th>Riesgo %</th>
            <th>Lotaje</th>
            <th>Tics Máximos</th>
            <th>Gap</th>
          </tr>
        </thead>
        <tbody id="optionsTable"></tbody>
      </table>
    </div>

  </div>

<script>
function calcular() {
  // Riesgos internos
  const riskArray = [0.0005, 0.0010, 0.00125, 0.0015, 0.0020, 0.0025, 0.0050, 0.01];

  const simbolo = document.getElementById('symbol').value;
  const comision = parseFloat(document.getElementById('comision').value);
  const capital = parseFloat(document.getElementById('capital').value);
  const slTics = parseFloat(document.getElementById('slTics').value);

  if (isNaN(slTics) || slTics <= 0) {
    alert("Introduce Tics SL válidos (>0).");
    return;
  }

  let valorPorTickPorLote, valorTickPrecio, decimales, contratos;
  if(simbolo === "XAU/USD"){ 
    valorPorTickPorLote = 1; valorTickPrecio = 0.01; decimales = 2; contratos = 100; 
  } else if(simbolo === "XAU/USD_OANDA"){ 
    valorPorTickPorLote = 0.1; valorTickPrecio = 0.001; decimales = 3; contratos = 100; 
  } else if(simbolo === "EUR/USD"){ 
    valorPorTickPorLote = 1; valorTickPrecio = 0.00001; decimales = 5; contratos = 100000;
  } else if(simbolo === "GBP/USD"){ 
    valorPorTickPorLote = 1; valorTickPrecio = 0.00001; decimales = 5; contratos = 100000;
  } else if(simbolo === "USD/JPY"){ 
    valorPorTickPorLote = 1; valorTickPrecio = 0.00001; decimales = 5; contratos = 100000;
  } else {
    valorPorTickPorLote = 1; valorTickPrecio = 0.0001; decimales = 5; contratos = 100000;
  }

  const DECIMALES_LOTE = 2;
  const factor = Math.pow(10, DECIMALES_LOTE);

  const table = document.getElementById('optionsTable');
  table.innerHTML = "";

  let validOptions = [];

  riskArray.forEach(r => {
    const RiesgoDinero = capital * r;

    let lotRaw = RiesgoDinero / (slTics * valorPorTickPorLote + comision);
    let lotRounded = Math.floor(lotRaw * factor) / factor;

    if (!isFinite(lotRounded) || lotRounded < 0.01) return;

    const comisionParaLot = lotRounded * comision;
    const numerador = RiesgoDinero - comisionParaLot;
    if (numerador <= 0) return;

    let ticsMaxRaw = numerador / (valorPorTickPorLote * lotRounded);
    let ticsMax = Math.ceil(ticsMaxRaw);
    if (!isFinite(ticsMax) || ticsMax <= 0) return;

    // ==== AJUSTE QUE PEDISTE ====
    ticsMax = ticsMax - 1;        // Restar 1 tic SIEMPRE
    if (ticsMax < slTics) return; // Si queda por debajo del SL ingresado → descartar
    // ============================

    const gap = ticsMax - slTics;

    validOptions.push({
      riesgo: r,
      lot: lotRounded,
      ticsMax,
      gap
    });
  });

  validOptions.sort((a,b) => Math.abs(a.gap) - Math.abs(b.gap));

  let bestIndex = validOptions.length > 0 ? 0 : -1;

  validOptions.forEach((opt, idx) => {
    const rowClass = (idx === bestIndex) ? "best-row" : "valid-row";
    table.insertAdjacentHTML('beforeend', `
      <tr class="${rowClass}">
        <td>${(opt.riesgo*100).toFixed(3)}%</td>
        <td>${opt.lot.toFixed(DECIMALES_LOTE)}</td>
        <td>${opt.ticsMax}</td>
        <td>${opt.gap >= 0 ? '+'+opt.gap : opt.gap}</td>
      </tr>
    `);
  });

  if (validOptions.length === 0) {
    table.insertAdjacentHTML('beforeend', `<tr><td colspan="4">No hay opciones válidas para SL = ${slTics} tics (lotes ≥ 0.01).</td></tr>`);
  }

  document.getElementById('resultCard').style.display='block';
  document.getElementById('container').style.justifyContent='flex-start';
}
</script>

</body>
</html>
